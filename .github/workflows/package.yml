name: Package

permissions:
  contents: write

on:
  push:
    branches: epic-scout

jobs:
  release:
    runs-on: ubuntu-latest
    if: "contains(github.event.head_commit.message, '[')"
    
    steps:
      - name: Install Checkout
        uses: actions/checkout@v1
      
      - name: Install Setup SP
        uses: rumblefrog/setup-sp@master
        with:
          version: '1.11.x'
      
      - name: Install Misc
        run: |
          bash scripts/setup.sh
          bash scripts/optional.sh
        working-directory: ./
      
      - name: Full Compile
        run: bash scripts/compile.sh
        working-directory: ${{ env.SCRIPTS_PATH }}
      
      - name: Package Sorting
        run: bash scripts/package.sh
      
      - name: Package Plugin
        uses: montudor/action-zip@v1
        if: "contains(github.event.head_commit.message, '[M]')"
        with:
          args: zip -qq -r FF2R-${{env.PLUGIN_VERSION}}.${{env.PLUGIN_VERSION_REVISION}}.zip plugin
      
      - name: Package Defaults
        uses: montudor/action-zip@v1
        if: "contains(github.event.head_commit.message, '[D]')"
        with:
          args: zip -qq -r Default-Bosses-${{env.PLUGIN_VERSION}}.${{env.PLUGIN_VERSION_REVISION}}.zip custom/ff2r_defaults
      
      - name: Package Epic Scout
        uses: montudor/action-zip@v1
        if: "contains(github.event.head_commit.message, '[E]')"
        with:
          args: zip -qq -r Epic-Scout-${{env.PLUGIN_VERSION}}.${{env.PLUGIN_VERSION_REVISION}}.zip custom/epic_scout
      
      - name: Release
        uses: softprops/action-gh-release@master
        with:
          tag_name: ${{env.PLUGIN_VERSION}}.${{env.PLUGIN_VERSION_REVISION}}
          files: |
            FF2R-${{env.PLUGIN_VERSION}}.${{env.PLUGIN_VERSION_REVISION}}.zip
            Default-Bosses-${{env.PLUGIN_VERSION}}.${{env.PLUGIN_VERSION_REVISION}}.zip
            Epic-Scout-${{env.PLUGIN_VERSION}}.${{env.PLUGIN_VERSION_REVISION}}.zip
  
  nonrelease:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[')"
    
    steps:
      - name: Install Checkout
        uses: actions/checkout@v1
      
      - name: Install Setup SP
        uses: rumblefrog/setup-sp@master
        with:
          version: '1.11.x'
      
      - name: Install Misc
        run: |
          bash scripts/setup.sh
          bash scripts/optional.sh
        working-directory: ./
      
      - name: Full Compile
        run: bash compile.sh
        working-directory: ${{ env.SCRIPTS_PATH }}
      
      - name: Package Sorting
        run:  bash scripts/package.sh
      
      - name: Upload Plugin
        uses: actions/upload-artifact@master
        with:
          name: FF2R-${{env.PLUGIN_VERSION}}.${{env.PLUGIN_VERSION_REVISION}}
          path: ./plugin
      
      - name: Upload Defaults
        uses: actions/upload-artifact@master
        with:
          name: Default-Bosses-${{env.PLUGIN_VERSION}}.${{env.PLUGIN_VERSION_REVISION}}
          path: ./custom/ff2r_defaults
      
      - name: Upload Epic Scout
        uses: actions/upload-artifact@master
        with:
          name: Epic-Scout-${{env.PLUGIN_VERSION}}.${{env.PLUGIN_VERSION_REVISION}}
          path: ./custom/epic_scout
